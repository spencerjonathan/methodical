<!DOCTYPE html>
<html lang="en">
<!-- ng-app="methodMadness" -->
<head>
<!-- Bootstrap core CSS -->
<link href="./bootstrap-3.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<!-- Bootstrap theme -->
<link href="./bootstrap-3.3.0/dist/css/bootstrap-theme.min.css"
	rel="stylesheet">
<style>
.table-no-border>thead>tr>th, .table-no-border>tbody>tr>th,
	.table-no-border>tfoot>tr>th, .table-no-border>thead>tr>td,
	.table-no-border>tbody>tr>td, .table-no-border>tfoot>tr>td {
	border-top: none;
	/* width: 100%; */
	padding: 0px 3px;
}
</style>

<meta name="google-signin-client_id"
	content="924998448066-mb9d1qmrqpkfjf0jcv4c43aqn9i9qokv.apps.googleusercontent.com">
</head>

<script src="./jquery-1.11.1.min.js"></script>
<script src="./bootstrap-3.3.0/dist/js/bootstrap.min.js"></script>
<script src="./angular.min.js"></script>
<script src="bootbox.js"></script>
<script src="https://apis.google.com/js/platform.js" async defer></script>

<script>
	function onSignIn(googleUser) {
		var profile = googleUser.getBasicProfile();
		console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
		console.log('Name: ' + profile.getName());
		console.log('Image URL: ' + profile.getImageUrl());
		console.log('Email: ' + profile.getEmail());
	}

	function signOut() {
		var auth2 = gapi.auth2.getAuthInstance();
		auth2.signOut().then(function() {
			console.log('User signed out.');
		});
	}

	function callPutWebService(responseHandler, errorHandler, url, data,
			contentType) {
		var xmlhttp = new XMLHttpRequest();

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				responseHandler(xmlhttp.responseText);
			}
			if (xmlhttp.readyState == 4 && xmlhttp.status == 500) {
				errorHandler(xmlhttp.responseText);
			}
		};

		xmlhttp.open("POST", url, true);
		xmlhttp.setRequestHeader('Content-Type', contentType)

		console.log(data);

		xmlhttp.send(data);

	}

	var drawList = function(list, htmlElement) {
		var innerHTML = '<select id="method-select-list" style="height:100px; width:100%;" class="no-scroll" multiple="true">';

		list.forEach(function(method) {

			innerHTML += '<option>' + method + '</option>';

		});

		console.log(innerHTML);
		htmlElement.innerHTML = innerHTML;
	}

	function createWebServiceURI(url, params) {

		var first = true;
		for ( var propt in params) {
			if (first) {
				url += "?";
				first = false;
			} else {
				url += "&";
			}
			url += propt + "=" + encodeURIComponent(params[propt])
		}
		console.log("createWebServiceURI generated: " + url);
		return url;
	}

	var callWebService = function(responseHandler, url) {
		var xmlhttp = new XMLHttpRequest();

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				responseHandler(xmlhttp.responseText);
			}
		};

		xmlhttp.open("GET", url, true);
		xmlhttp.send();
	}

	var g_method_list = [];

	function setSearchText(text) {
		document.getElementById("method-name").value = text;
	}

	function addMethodName() {
		var name = document.getElementById('method-name').value;

		g_method_list.forEach(function(method) {
			if (name == method)
				return;
		});

		g_method_list.push(name);

		drawMethodList();

		document.getElementById('method-name').value = "";
	}

	function removeMethodName() {
		var select_list = document.getElementById("method-select-list");
		var name = select_list.options[select_list.selectedIndex].text;

		var new_list = [];

		g_method_list.forEach(function(method) {
			if (name != method)
				new_list.push(method);
		});

		g_method_list = new_list;

		drawMethodList();
	}

	function searchMethods(parameters) {
		var ws = createWebServiceURI('./ws/getMethodByTitle', parameters);

		callWebService(
				function(resultset) {
					var obj = JSON.parse(resultset);

					var innerHTML = "";
					obj
							.forEach(function(method) {

								method = method.replace(/'/g, "\\'");
								innerHTML += '<li style="cursor:pointer" onclick="setSearchText(\''
										+ method + '\');">' + method + '</li>';

							});

					console.log(innerHTML);
					document.getElementById("method-dropdown").innerHTML = innerHTML;

				}, ws);

		return g_method_list;
	}

	function drawMethodList() {
		drawList(g_method_list, document
				.getElementById("selected-methods-list"));
	}

	function generateTouch() {
		var touch = "";

		var method_number = 0;
		g_method_list.forEach(function(method) {
			touch += 'METHOD M' + ++method_number + ' = "' + method + '"\n'
		});
		touch += "\nCALL B = " + document.getElementById('bobnotation').value
				+ "\n";
		touch += "CALL S = " + document.getElementById('singlenotation').value
				+ "\n";
		touch += "\nPART P1 = { P P P P P }\nCOMPOSITION = { M1 P1 }";

		document.getElementById('input').value = touch;
	}

	function loadComposition(compositionId) {

		var ws = createWebServiceURI('./ws/getComposition', {
			id : compositionId
		});

		callWebService(function(result) {
			var obj = JSON.parse(result);
			document.getElementById('input').value = obj.composition;
		}, ws);
	}

	function saveComposition() {
		var title = document.getElementById('compositionname').value;
		var ws = createWebServiceURI('./ws/saveComposition', {
			title : title
		});

		var composition_string = document.getElementById("input").value;

		callPutWebService(handleSaveResponse, errorResponse, ws,
				composition_string, 'text/html');
	}

	function saveCompositionDialog() {
		callWebService(function(result) {
			dialogWizard("Save Composition", result, function() {
			}, "Save", saveComposition);
		}, "./savecomposition.xml");
	}

	function touchWizard() {
		callWebService(function(result) {
			dialogWizard("Touch Wizard", result, drawMethodList, "Generate",
					generateTouch);
		}, "./touchwizard.xml");
	}

	function dialogWizard(title, bodyHTML, drawFunction, submitLabel,
			submitFunction) {

		var d = bootbox.dialog({
			title : title,
			show : false,
			//size : "large",
			message : bodyHTML,
			buttons : {
				cancel : {
					label : "Cancel",
					className : "btn-cancel",
					callback : function() {
					}
				},
				success : {
					label : submitLabel,
					className : "btn-primary",
					callback : function() {
						submitFunction();
					}
				}
			}
		});

		// Make sure we draw the list of methods previously selected when the dialog is drawn
		d.on("show.bs.modal", function() {
			drawFunction();
		});

		// Now lets draw the dialog
		d.modal("show");

	}

	function submit() {
		var composition = document.getElementById("input").value;
		var music = document.getElementById("music-input").value;
		var stopAtRounds = document.getElementById("stop-at-rounds").checked;

		var data_string = JSON.stringify({
			"composition" : composition,
			"music" : music,
			"stopAtRounds" : stopAtRounds
		});
		callPutWebService(handleResponse, errorResponse, "./ws/parse",
				data_string, 'application/json');

	}

	function errorResponse(responseText) {
		var error = JSON.parse(responseText);
		document.getElementById("warning").innerHTML = "<strong>Warning!</strong> "
				+ error.message;
		document.getElementById("warning").style.display = "block";
		document.getElementById("success").style.display = "none";
	}

	function handleResponse(responseText) {

		var touch = JSON.parse(responseText);
		if (touch.exception) {
			document.getElementById("warning").innerHTML = "<strong>Warning!</strong> "
					+ touch.message;
			document.getElementById("warning").style.display = "block";
			document.getElementById("success").style.display = "none";
		} else {
			drawTouch(touch);
			drawRepetition(touch);
			drawMusic(touch);
			document.getElementById("warning").style.display = "none";
			document.getElementById("success").style.display = "none";
		}
	}

	function handleSaveResponse(responseText) {

		var response = JSON.parse(responseText);
		if (response > 0) {
			document.getElementById("success").innerHTML = "<strong>Composition Saved!</strong> ";
			document.getElementById("success").style.display = "block";
			document.getElementById("warning").style.display = "none";
		} else {
			document.getElementById("warning").innerHTML = "<strong>Composition Saved!</strong> ";
			document.getElementById("warning").style.display = "block";
			document.getElementById("success").style.display = "none";
		}

	}

	function drawTouch(touch) {
		var touchTitle = "";
		var touchPanelClass = "panel panel-success";
		var innerHTML = "";

		touchTitle = "Touch of " + touch.touch_length + " changes"

		if (touch.repetitious) {
			touchTitle += ", containing repetition";
			touchPanelClass = "panel panel-warning";
		} else {
			touchPanelClass = "panel panel-success";
			touchTitle += ", without repetition";
		}

		if (touch.comesRound) {
			touchTitle += ", that does come round.";
		} else {
			touchTitle += ", that does not come round.";
			var touchPanelClass = "panel panel-danger";
		}

		document.getElementById("touchPanel").setAttribute("class",
				touchPanelClass);

		innerHTML = '<table class="table-no-border" ><thead><tr><th>Method</th><th>Lead Head</th><th>Call</th></tr></thead><tbody>';

		var leads = touch.leads;

		touch.leads.forEach(function(lead) {
			innerHTML += "<tr><td>" + lead.method + "</td><td>"
					+ lead.bell_order + "</td><td>" + lead.call + "</td></tr>";

		});
		innerHTML += "</table>";

		document.getElementById("touchPanelBody").innerHTML = innerHTML;
		document.getElementById("touchHeading").innerHTML = touchTitle;
	}

	function drawMusic(touch) {
		var musicTitle = "";
		var musicPanelClass = "panel panel-success";
		var innerHTML = "";

		innerHTML = '<table class="table" style="width: 0%;"><thead><tr><th>Music</th><th>Occurances</th></tr></thead><tbody>';

		var music = touch.music;

		touch.music.forEach(function(m) {
			innerHTML += "<tr><td>" + m.name + "</td><td>" + m.occurances
					+ "</td></tr>";

		});
		innerHTML += "</table>";

		document.getElementById("musicPanelBody").innerHTML = innerHTML;
	}

	function drawRepetition(touch) {

		var innerHTML = '<table class="table"><thead><tr><th>Change</th><th>First Lead</th><th>First Lead Change Number</th><th>First Lead Stroke</th><th>Second Lead</th><th>Second Lead Change Number</th><th>Second Lead Stroke</th></tr></thead><tbody>';

		var repetitions = touch.repetitive_changes;

		repetitions.forEach(function(repetition) {
			innerHTML += "<tr><td>" + repetition.row + "</td>";
			innerHTML += "<td>" + repetition.first_lead_number + "</td>"
			innerHTML += "<td>" + repetition.row_number_in_first_le + "</td>"
			if (repetition.at_hand_in_first_le)
				innerHTML += "<td>Hand</td>";
			else
				innerHTML += "<td>Back</td>";
			innerHTML += "<td>" + repetition.second_lead_number + "</td>"
			innerHTML += "<td>" + repetition.row_number_in_second_le + "</td>"
			if (repetition.at_hand_in_second_le)
				innerHTML += "<td>Hand</td>";
			else
				innerHTML += "<td>Back</td>";
			innerHTML += "</tr>";

		});
		innerHTML += "</table>";

		document.getElementById("repetitionPanelBody").innerHTML = innerHTML;
	}

	function updateDropdown() {
		console.log("In updateDropdown()")

		var string_length = $('#method-name').val().length;

		if (string_length > 3) {
			searchMethods({
				searchString : $('#method-name').val()
			});

		}
	}

	function autoload() {
		var str = window.location.search;
		var objURL = {};

		str.replace(new RegExp("([^?=&]+)(=([^&]*))?", "g"), function($0, $1,
				$2, $3) {
			objURL[$1] = $3;
		});

		if (objURL["composition"] != null) {
			loadComposition(objURL["composition"]);
		}

	}
</script>

<body role="document" onload="autoload()">
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<div class="container">
					<img src="./MethodMadness.jpg" />

					<div style="float: right" class="g-signin2 navbar-btn"
						data-onsuccess="onSignIn"></div>


				</div>
				<!--/.nav-collapse -->
			</div>
		</div>


	</nav>


	<br>
	<br>

	<br>
	<br>
	<div class="col-sm-12">
		<div id="warning" style="display: none"
			class="col-sm-12 alert alert-warning" role="alert">
			<strong>Warning!</strong> Best check yo self, you're not looking too
			good.
		</div>

		<div id="success" style="display: none"
			class="col-sm-12 alert alert-success" role="alert">
			<strong>Warning!</strong> Best check yo self, you're not looking too
			good.
		</div>

		<div class="col-md-6">
			<div class="panel panel-info">
				<div class="panel-heading">
					<h3 class="panel-title">Enter Composition</h3>

				</div>
				<div class="panel-body">
					<button type="button" class="btn btn-sm btn-primary"
						onClick="touchWizard()">Touch Wizard &raquo;</button>
					<button type="button" class="btn btn-sm btn-primary"
						title="Save Composition" onClick="saveCompositionDialog()">
						<span class="glyphicon glyphicon-floppy-save" aria-hidden="true"></span>
						Save
					</button>
					<button type="button" class="btn btn-sm btn-primary"
						title="Submit Composition" onClick="submit()">
						<span class="glyphicon glyphicon-play" aria-hidden="true"></span>
						Submit
					</button>
					<label> <input id="stop-at-rounds" type="checkbox"
						checked="true"> Stop at Rounds?
					</label>

					<textarea id="input" style="width: 100%; height: 300px"></textarea>
					<br>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">Music Definition</h3>
				</div>
				<div class="panel-body">
					<textarea id="music-input" style="width: 100%; height: 330px">"Queens" = 135246
"Titums" = 142536
"Rollup" = 456$
"546" = 546$</textarea>

				</div>
			</div>
		</div>

		<br>
		<hr>
		<div class="col-md-6">
			<div id="touchPanel" class="panel panel-success">
				<div class="panel-heading">
					<h3 id="touchHeading" class="panel-title">Touch Result</h3>
				</div>
				<div id="touchPanelBody" class="panel-body"></div>
			</div>
		</div>
		<div class="col-md-6">
			<div id="touchPanel" class="panel panel-success ">
				<div class="panel-heading">
					<h3 class="panel-title">Music Found</h3>
				</div>
				<div id="musicPanelBody" class="panel-body"></div>
			</div>
		</div>
		<div class="col-md-12">
			<div class="panel panel-warning">
				<div class="panel-heading">
					<h3 class="panel-title">Repetition</h3>
				</div>
				<div id="repetitionPanelBody" class="panel-body"></div>
			</div>
		</div>
	</div>

</body>
</html>
