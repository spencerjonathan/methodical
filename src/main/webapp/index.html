<!DOCTYPE html>
<html lang="en">
<!-- ng-app="methodMadness" -->
<head>
<!-- Bootstrap core CSS -->
<link href="./bootstrap-3.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<!-- Bootstrap theme -->
<link href="./bootstrap-3.3.0/dist/css/bootstrap-theme.min.css"
	rel="stylesheet">
<style>
.table-no-border>thead>tr>th, .table-no-border>tbody>tr>th,
	.table-no-border>tfoot>tr>th, .table-no-border>thead>tr>td,
	.table-no-border>tbody>tr>td, .table-no-border>tfoot>tr>td {
	border-top: none;
	/* width: 100%; */
	padding: 0px 3px;
}
</style>

<meta name="google-signin-client_id"
	content="924998448066-mb9d1qmrqpkfjf0jcv4c43aqn9i9qokv.apps.googleusercontent.com">
</head>

<script src="./jquery-1.11.1.min.js"></script>
<script src="./bootstrap-3.3.0/dist/js/bootstrap.min.js"></script>
<script src="./angular.min.js"></script>
<script src="bootbox.js"></script>
<script src="https://apis.google.com/js/platform.js" async defer></script>

<script>
	function onSignIn(googleUser) {
		var profile = googleUser.getBasicProfile();
		console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
		console.log('Name: ' + profile.getName());
		console.log('Image URL: ' + profile.getImageUrl());
		console.log('Email: ' + profile.getEmail());
	}

	function signOut() {
		var auth2 = gapi.auth2.getAuthInstance();
		auth2.signOut().then(function() {
			console.log('User signed out.');
		});
	}

	function callPutWebService(responseHandler, errorHandler, url, data,
			contentType) {
		var xmlhttp = new XMLHttpRequest();

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				responseHandler(xmlhttp.responseText);
			}
			if (xmlhttp.readyState == 4 && xmlhttp.status == 500) {
				errorHandler(xmlhttp.responseText);
			}
		};

		xmlhttp.open("POST", url, true);
		xmlhttp.setRequestHeader('Content-Type', contentType)

		console.log(data);

		xmlhttp.send(data);

	}

	var drawList = function(list, htmlElement) {
		var innerHTML = '<select id="method-select-list" style="height:100px; width:100%;" class="no-scroll" multiple="true">';

		list.forEach(function(method) {

			innerHTML += '<option>' + method + '</option>';

		});

		console.log(innerHTML);
		htmlElement.innerHTML = innerHTML;
	}

	function createWebServiceURI(url, params) {

		var first = true;
		for ( var propt in params) {
			if (first) {
				url += "?";
				first = false;
			} else {
				url += "&";
			}
			url += propt + "=" + encodeURIComponent(params[propt])
		}
		console.log("createWebServiceURI generated: " + url);
		return url;
	}

	var callWebService = function(responseHandler, url) {
		var xmlhttp = new XMLHttpRequest();

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				responseHandler(xmlhttp.responseText);
			}
		};

		xmlhttp.open("GET", url, true);
		xmlhttp.send();
	}

	var g_method_list = [];

	function setSearchText(text) {
		document.getElementById("method-name").value = text;
	}

	function addMethodName() {
		var name = document.getElementById('method-name').value;

		g_method_list.forEach(function(method) {
			if (name == method)
				return;
		});

		g_method_list.push(name);

		drawMethodList();

		document.getElementById('method-name').value = "";
	}

	function removeMethodName() {
		var select_list = document.getElementById("method-select-list");
		var name = select_list.options[select_list.selectedIndex].text;

		var new_list = [];

		g_method_list.forEach(function(method) {
			if (name != method)
				new_list.push(method);
		});

		g_method_list = new_list;

		drawMethodList();
	}

	function searchMethods(parameters) {
		var ws = createWebServiceURI(urlPrefix + 'getMethodByTitle', parameters);

		callWebService(
				function(resultset) {
					var obj = JSON.parse(resultset);

					var innerHTML = "";
					obj
							.forEach(function(method) {

								method = method.replace(/'/g, "\\'");
								innerHTML += '<li style="cursor:pointer" onclick="setSearchText(\''
										+ method + '\');">' + method + '</li>';

							});

					console.log(innerHTML);
					document.getElementById("method-dropdown").innerHTML = innerHTML;

				}, ws);

		return g_method_list;
	}

	function drawMethodList() {
		drawList(g_method_list, document
				.getElementById("selected-methods-list"));
	}

	function generateTouch() {
		var touch = "";

		var method_number = 0;
		g_method_list.forEach(function(method) {
			touch += 'METHOD M' + ++method_number + ' = "' + method + '"\n'
		});
		touch += "\nCALL B = " + document.getElementById('bobnotation').value
				+ "\n";
		touch += "CALL S = " + document.getElementById('singlenotation').value
				+ "\n";
		touch += "\nPART P1 = { P P P P P }\nCOMPOSITION = { M1 P1 }";

		document.getElementById('input').value = touch;
	}

	function loadComposition(compositionId) {

		var ws = createWebServiceURI(urlPrefix + 'getComposition', {
			id : compositionId
		});

		callWebService(function(result) {
			var obj = JSON.parse(result);
			document.getElementById('input').value = obj.composition;
		}, ws);
	}

	var g_composition_id = 0;

	function openComposition() {
		loadComposition(g_composition_id)
	}

	function openCompositionDialog() {
		callWebService(function(result) {
			dialogWizard("Save Composition", result, function() {
			}, "Open", openComposition);
		}, "./loadcomposition.xml");
	}

	function findCompositions() {
		var title = document.getElementById('findcompositionname').value;
		var ws = createWebServiceURI(urlPrefix + 'saveComposition', {
			title : title
		});

		callWebService(function(result) {
			var obj = JSON.parse(result);
			document.getElementById('input').value = obj.composition;
		}, ws);
	}

	var compositions_found = [];

	function populateFoundCompositions(row) {

		if (row != undefined) {
			selected_composition = compositions_found[row].id;

		}

		var innerHTML = "<table class=\"table\"> <thead> \
		<tr> \
		<th>ID</th> \
		<th>Name</th> \
		<th>Author</th> \
		<th>Created Date</th> \
		</tr> </thead>";

		for (i = 0; i < g_compositions_found.length; ++i) {

			innerHTML += "<tr";
			if (row == i) {
				innerHTML += " class=\"active\"";
			}
			innerHTML += " style=\"cursor:pointer\" onclick=\"insertData(" + i
					+ ")\"> \
			<td>" + g_compositions_found[i].id
					+ "</td> \
			<td>" + g_compositions_found[i].name
					+ "</td> \
			<td>" + compositions_found[i].author
					+ "</td> \
			<td>" + compositions_found[i].createdDate
					+ "</td> \
			</tr>";

		}
		;

		innerHTML = innerHTML + "</table>";
		console.log(innerHTML);
		document.getElementById("composition_table").innerHTML = innerHTML;
	}

	function saveComposition() {
		var title = document.getElementById('compositionname').value;
		var ws = createWebServiceURI(urlPrefix + 'saveComposition', {
			title : title
		});

		var composition_string = document.getElementById("input").value;

		callPutWebService(handleSaveResponse, errorResponse, ws,
				composition_string, 'text/html');
	}

	function saveCompositionDialog() {
		callWebService(function(result) {
			dialogWizard("Save Composition", result, function() {
			}, "Save", saveComposition);
		}, "./savecomposition.xml");
	}

	function touchWizard() {
		callWebService(function(result) {
			dialogWizard("Touch Wizard", result, drawMethodList, "Generate",
					generateTouch);
		}, "./touchwizard.xml");
	}

	function dialogWizard(title, bodyHTML, drawFunction, submitLabel,
			submitFunction) {

		var d = bootbox.dialog({
			title : title,
			show : false,
			//size : "large",
			message : bodyHTML,
			buttons : {
				cancel : {
					label : "Cancel",
					className : "btn-cancel",
					callback : function() {
					}
				},
				success : {
					label : submitLabel,
					className : "btn-primary",
					callback : function() {
						submitFunction();
					}
				}
			}
		});

		// Make sure we draw the list of methods previously selected when the dialog is drawn
		d.on("show.bs.modal", function() {
			drawFunction();
		});

		// Now lets draw the dialog
		d.modal("show");

	}

	var SubmitButton = function(p_submitButton, p_composition_input,
			p_music_input, p_stopAtRounds_input, p_touch_output,
			p_music_output, p_repetition_output) {

		var handleResponse = function(responseText) {

			var touch = JSON.parse(responseText);
			if (touch.exception) {
				document.getElementById("warning").innerHTML = "<strong>Warning!</strong> "
						+ touch.message;
				document.getElementById("warning").style.display = "block";
				document.getElementById("success").style.display = "none";
			} else {
				p_touch_output.draw(touch);
				p_repetition_output.draw(touch);
				p_music_output.draw(touch);
				document.getElementById("warning").style.display = "none";
				document.getElementById("success").style.display = "none";
			}
		};

		function errorResponse(responseText) {
			var error = JSON.parse(responseText);
			document.getElementById("warning").innerHTML = "<strong>Warning!</strong> "
					+ error.message;
			document.getElementById("warning").style.display = "block";
			document.getElementById("success").style.display = "none";
		}

		var onClick = function(event) {
			var data_string = JSON.stringify({
				"composition" : p_composition_input.value,
				"music" : p_music_input.value,
				"stopAtRounds" : p_stopAtRounds_input.checked
			});

			callPutWebService(handleResponse, errorResponse, urlPrefix
					+ "parse", data_string, 'application/json');
		};

		p_submitButton.onclick = onClick;

	};

	function handleSaveResponse(responseText) {

		var response = JSON.parse(responseText);
		if (response > 0) {
			document.getElementById("success").innerHTML = "<strong>Composition Saved!</strong> ";
			document.getElementById("success").style.display = "block";
			document.getElementById("warning").style.display = "none";
		} else {
			document.getElementById("warning").innerHTML = "<strong>Composition Saved!</strong> ";
			document.getElementById("warning").style.display = "block";
			document.getElementById("success").style.display = "none";
		}

	}



	function updateDropdown() {
		console.log("In updateDropdown()")

		var string_length = $('#method-name').val().length;

		if (string_length > 3) {
			searchMethods({
				searchString : $('#method-name').val()
			});

		}
	}

	var urlPrefix = "ws/";

	function autoload() {
		var str = window.location.search;
		var objURL = {};

		str.replace(new RegExp("([^?=&]+)(=([^&]*))?", "g"), function($0, $1,
				$2, $3) {
			objURL[$1] = $3;
		});

		if (objURL["composition"] != null) {
			loadComposition(objURL["composition"]);
		}

		if (objURL["embedded"] != null) {
			urlPrefix = "";
		}

	}

	/*
	 *  Class for controlling the output of the touch
	 */

	var GenericPanel = function(p_panel, p_heading, p_body) {

		this.panel = p_panel;
		this.body = p_body;
		this.heading = p_heading;

		// Setter methods
		this.setPanel = function(c) {
			this.panel.setAttribute("class", "panel panel-" + c);
		};

		this.setHeading = function(heading) {
			this.heading.innerHTML = heading;
		};

		this.setBody = function(text) {
			this.body.innerHTML = text
		};

	}

	function TouchPanel(p_panel, p_heading, p_body) {
		GenericPanel.call(this, p_panel, p_heading, p_body);
	};
	
	TouchPanel.prototype = Object.create(GenericPanel.prototype);
	
	TouchPanel.prototype.draw = function(touch) {
		var touchTitle = "";
		var touchPanelClass = "panel panel-success";
		var innerHTML = "";

		touchTitle = "Touch of " + touch.touch_length + " changes"

		if (touch.repetitious) {
			touchTitle += ", containing repetition";
			touchPanelClass = "warning";
		} else {
			touchPanelClass = "success";
			touchTitle += ", without repetition";
		}

		if (touch.comesRound) {
			touchTitle += ", that does come round.";
		} else {
			touchTitle += ", that does not come round.";
			var touchPanelClass = "danger";
		}

		innerHTML = '<table class="table-no-border" ><thead><tr><th>Method</th><th>Lead Head</th><th>Call</th></tr></thead><tbody>';

		var leads = touch.leads;

		touch.leads.forEach(function(lead) {
			innerHTML += "<tr><td>" + lead.method + "</td><td>"
					+ lead.bell_order + "</td><td>" + lead.call + "</td></tr>";

		});
		innerHTML += "</table>";

		this.setPanel(touchPanelClass);
		this.setBody(innerHTML);
		this.setHeading(touchTitle);
	}
	
	function MusicPanel(p_panel, p_heading, p_body) {
		GenericPanel.call(this, p_panel, p_heading, p_body);
	};
	
	MusicPanel.prototype = Object.create(GenericPanel.prototype);

	MusicPanel.prototype.draw = function(touch) {
		var musicTitle = "";
		var musicPanelClass = "panel panel-success";
		var innerHTML = "";

		innerHTML = '<table class="table" style="width: 0%;"><thead><tr><th>Music</th><th>Occurances</th></tr></thead><tbody>';

		var music = touch.music;

		touch.music.forEach(function(m) {
			innerHTML += "<tr><td>" + m.name + "</td><td>" + m.occurances
					+ "</td></tr>";

		});
		innerHTML += "</table>";

		//document.getElementById("musicPanelBody").innerHTML = innerHTML;
		this.setBody(innerHTML);
	}

	function RepetitionPanel(p_panel, p_heading, p_body) {
		GenericPanel.call(this, p_panel, p_heading, p_body);
	};
	
	RepetitionPanel.prototype = Object.create(GenericPanel.prototype);
	
	RepetitionPanel.prototype.draw = function(touch) {

		var innerHTML = '<table class="table"><thead><tr><th>Change</th><th>First Lead</th><th>First Lead Change Number</th><th>First Lead Stroke</th><th>Second Lead</th><th>Second Lead Change Number</th><th>Second Lead Stroke</th></tr></thead><tbody>';

		var repetitions = touch.repetitive_changes;

		repetitions.forEach(function(repetition) {
			innerHTML += "<tr><td>" + repetition.row + "</td>";
			innerHTML += "<td>" + repetition.first_lead_number + "</td>"
			innerHTML += "<td>" + repetition.row_number_in_first_le + "</td>"
			if (repetition.at_hand_in_first_le)
				innerHTML += "<td>Hand</td>";
			else
				innerHTML += "<td>Back</td>";
			innerHTML += "<td>" + repetition.second_lead_number + "</td>"
			innerHTML += "<td>" + repetition.row_number_in_second_le + "</td>"
			if (repetition.at_hand_in_second_le)
				innerHTML += "<td>Hand</td>";
			else
				innerHTML += "<td>Back</td>";
			innerHTML += "</tr>";

		});
		innerHTML += "</table>";

		this.setBody(innerHTML);
		//document.getElementById("repetitionPanelBody").innerHTML = innerHTML;
	}
	
</script>

<body role="document" onload="autoload()">
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<div class="container">
					<img src="./MethodMadness.jpg" />

					<div style="float: right" class="g-signin2 navbar-btn"
						data-onsuccess="onSignIn"></div>


				</div>
				<!--/.nav-collapse -->
			</div>
		</div>


	</nav>


	<br>
	<br>

	<br>
	<br>
	<div class="col-sm-12">
		<div id="warning" style="display: none"
			class="col-sm-12 alert alert-warning" role="alert">
			<strong>Warning!</strong> Best check yo self, you're not looking too
			good.
		</div>

		<div id="success" style="display: none"
			class="col-sm-12 alert alert-success" role="alert">
			<strong>Warning!</strong> Best check yo self, you're not looking too
			good.
		</div>

		<div class="col-md-6">
			<div class="panel panel-info">
				<div class="panel-heading">
					<h3 class="panel-title">Enter Composition</h3>

				</div>
				<div class="panel-body">
					<button type="button" class="btn btn-sm btn-primary"
						onClick="touchWizard()">Touch Wizard &raquo;</button>
					<button type="button" class="btn btn-sm btn-primary"
						title="Save Composition" onClick="saveCompositionDialog()">
						<span class="glyphicon glyphicon-floppy-save" aria-hidden="true"></span>
						Save
					</button>
					<button type="button" class="btn btn-sm btn-primary"
						title="Open Composition" onClick="openCompositionDialog()">
						<span class="glyphicon glyphicon-floppy-open" aria-hidden="true"></span>
						Open
					</button>
					<button type="button" class="btn btn-sm btn-primary" id="submit"
						title="Submit Composition" onClick="submit()">
						<span class="glyphicon glyphicon-play" aria-hidden="true"></span>
						Submit
					</button>
					<label> <input id="stop-at-rounds" type="checkbox"
						checked="true"> Stop at Rounds?
					</label>

					<textarea id="input" style="width: 100%; height: 300px"></textarea>
					<br>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">Music Definition</h3>
				</div>
				<div class="panel-body">
					<textarea id="music-input" style="width: 100%; height: 330px">"Queens" = 135246
"Titums" = 142536
"Rollup" = 456$
"546" = 546$</textarea>

				</div>
			</div>
		</div>

		<br>
		<hr>
		<div class="col-md-6">
			<div id="touchPanel" class="panel panel-success">
				<div class="panel-heading">
					<h3 id="touchHeading" class="panel-title">Touch Result</h3>
				</div>
				<div id="touchPanelBody" class="panel-body"></div>
			</div>
		</div>
		<div class="col-md-6">
			<div id="musicPanel" class="panel panel-success ">
				<div class="panel-heading">
					<h3 id="musicHeading" class="panel-title">Music Found</h3>
				</div>
				<div id="musicPanelBody" class="panel-body"></div>
			</div>
		</div>
		<div class="col-md-12">
			<div id="repetitionPanel" class="panel panel-warning">
				<div class="panel-heading">
					<h3 id="repetitionHeading" class="panel-title">Repetition</h3>
				</div>
				<div id="repetitionPanelBody" class="panel-body"></div>
			</div>
		</div>
	</div>

</body>

<script>
	var g_touchPanel = new TouchPanel(document.getElementById("touchPanel"),
			document.getElementById("touchHeading"), document
					.getElementById("touchPanelBody"));

	var g_musicPanel = new MusicPanel(document.getElementById("musicPanel"),
			document.getElementById("musicHeading"), document
					.getElementById("musicPanelBody"));
	
	var g_repetitionPanel = new RepetitionPanel(document.getElementById("repetitionPanel"),
			document.getElementById("repetitionHeading"), document
					.getElementById("repetitionPanelBody"));
	
	var g_submitButton = new SubmitButton(document.getElementById("submit"),
			document.getElementById("input"), document
					.getElementById("music-input"), document
					.getElementById("stop-at-rounds"), g_touchPanel,
			//document.getElementById("touchPanelBody"),
			g_musicPanel, //document.getElementById("musicPanelBody"),
			g_repetitionPanel
			//document.getElementById("repetitionPanelBody")
			);
</script>
</html>
